name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Docker and configure sudo
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            # Install Docker
            curl -fsSL https://get.docker.com -o get-docker.sh
            chmod +x get-docker.sh
            bash get-docker.sh
          fi

          # Check if Docker Compose is installed
          if ! command -v docker-compose &> /dev/null; then
            # Install Docker Compose
            sudo apt update
            sudo apt install -y docker-compose
          fi

          # Add user to docker group if not already
          if ! groups | grep -q docker; then
            sudo usermod -aG docker $USER
            echo "Added user to docker group. This will take effect after next login."
          fi
          
          # Configure passwordless sudo for docker and docker-compose
          echo "Configuring passwordless sudo for docker commands..."
          sudo tee /etc/sudoers.d/docker-commands > /dev/null << EOL
          $USER ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose
          EOL
          sudo chmod 440 /etc/sudoers.d/docker-commands
          
          # Install Apache2 if not already installed
          if ! command -v apache2ctl &> /dev/null; then
            sudo apt update
            sudo apt install -y apache2
          fi
          
          # Enable necessary Apache modules
          sudo a2enmod proxy proxy_http proxy_wstunnel ssl rewrite
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          mkdir -p ~/sanad
          cd ~/sanad
          
          # Clone or update repository
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git init
            git remote add origin https://github.com/aselims/sanad.git
            git fetch origin main
            git reset --hard origin/main
          fi
          
          # Create .env file with secrets
          cat > .env << EOL
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=sanad
          EOL
          
          # Make dev.sh executable
          chmod +x dev.sh
          
          # Stop any running containers (if they exist)
          sudo docker compose down || true
          
          # Create docker-compose.override.yml for production settings
          cat > docker-compose.override.yml << EOLDC
          version: '3.8'
          services:
            frontend:
              environment:
                - VITE_API_URL=https://sanad.selimsalman.de/api
                - VITE_APP_DOMAIN=sanad.selimsalman.de
            backend:
              environment:
                - NODE_ENV=production
                - CORS_ORIGIN=https://sanad.selimsalman.de
          EOLDC
          
          # Start using dev.sh script with dev-compose and remote flags
          # The --remote flag ensures we use the production API endpoint
          # The --dev-compose flag ensures we use docker-compose.dev.yml
          # The --verbose flag enables detailed logging
          nohup ./dev.sh --remote https://sanad.selimsalman.de/ --dev-compose --verbose > deployment.log 2>&1 &
          
          # Wait for services to start
          echo "Waiting for services to start..."
          sleep 15
          
          # Run database seed script to populate initial data
          echo "Running database seed script..."
          # Enter backend container and run the seed script
          sudo docker compose -f docker-compose.dev.yml exec -T backend node dist/scripts/seed-database.js >> deployment.log 2>&1 || echo "Seed script failed - database may already be populated"
          
          # First create a basic HTTP virtual host for Certbot validation
          sudo tee /etc/apache2/sites-available/sanad.conf > /dev/null << EOL
          <VirtualHost *:80>
              ServerName sanad.selimsalman.de
              
              # Frontend proxy
              ProxyPreserveHost On
              ProxyPass / http://localhost:8081/
              ProxyPassReverse / http://localhost:8081/
              
              # API proxy - ensure no double /api prefix
              ProxyPass /api http://localhost:3001/
              ProxyPassReverse /api http://localhost:3001/
              
              ErrorLog \${APACHE_LOG_DIR}/sanad-error.log
              CustomLog \${APACHE_LOG_DIR}/sanad-access.log combined
          </VirtualHost>
          EOL
          
          # Enable site and reload Apache
          sudo a2ensite sanad.conf
          sudo systemctl reload apache2
          
          # Install certbot if not available
          if ! command -v certbot &> /dev/null; then
            sudo apt update
            sudo apt install -y certbot python3-certbot-apache
          fi
          
          # Get SSL certificate using certbot
          sudo certbot --apache -d sanad.selimsalman.de --non-interactive --agree-tos --email admin@selimsalman.de
          
          # Now update the config with proper SSL settings
          # Certbot should have already updated the Apache config, but we'll make sure our proxies are configured correctly
          sudo tee /etc/apache2/sites-available/sanad-le-ssl.conf > /dev/null << EOL
          <IfModule mod_ssl.c>
          <VirtualHost *:443>
              ServerName sanad.selimsalman.de
              
              # Frontend proxy
              ProxyPreserveHost On
              ProxyPass / http://localhost:8081/
              ProxyPassReverse / http://localhost:8081/
              
              # API proxy - ensure no double /api prefix
              ProxyPass /api http://localhost:3001/
              ProxyPassReverse /api http://localhost:3001/
              
              # WebSocket support
              RewriteEngine On
              RewriteCond %{HTTP:Upgrade} =websocket [NC]
              RewriteRule /(.*)  ws://localhost:8081/$1 [P,L]
              
              ErrorLog \${APACHE_LOG_DIR}/sanad-error.log
              CustomLog \${APACHE_LOG_DIR}/sanad-access.log combined
              
              Include /etc/letsencrypt/options-ssl-apache.conf
              SSLCertificateFile /etc/letsencrypt/live/sanad.selimsalman.de/fullchain.pem
              SSLCertificateKeyFile /etc/letsencrypt/live/sanad.selimsalman.de/privkey.pem
          </VirtualHost>
          </IfModule>
          EOL
          
          # Reload Apache after configuration update
          sudo systemctl reload apache2
          
          echo "Deployment complete. Site is available at https://sanad.selimsalman.de"
